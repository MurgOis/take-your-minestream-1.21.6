# Система сообщений - Архитектура

После рефакторинга система сообщений была разбита на отдельные компоненты с четким разделением ответственности.

## Компоненты

### 1. Message

**Файл:** `Message.java`
**Ответственность:** Модель данных для отображаемого сообщения

- Хранит текст, позицию, время создания и счетчик замороженных тиков
- Предоставляет метод для вычисления эффективного возраста с учетом заморозки

### 2. MessagePosition

**Файл:** `MessagePosition.java`
**Ответственность:** Генерация позиций для сообщений

- Создает случайные позиции вокруг игрока
- Настраивает радиус и высоту появления сообщений

### 3. MessageViewDetector

**Файл:** `MessageViewDetector.java`
**Ответственность:** Определение направления взгляда игрока

- **НОВАЯ ЛОГИКА:** Проверяет пересечение луча взгляда с плоскостью сообщения
- Использует ray-plane intersection вместо проверки угла к центру
- **Динамически вычисляет размеры** каждого сообщения на основе его текста
- Проверяет максимальное расстояние для заморозки

**Алгоритм работы:**

1. Вычисляет эффективный возраст сообщения (с учетом заморозки)
2. Вычисляет смещение при падении (та же логика, что и в MessageRenderer)
3. Вычисляет размеры сообщения на основе текста (как в MessageRenderer)
4. Вычисляет точку пересечения луча взгляда с плоскостью сообщения
5. Проверяет, находится ли точка пересечения в пределах границ текстуры
6. Учитывает поворот сообщения (yaw/pitch) для правильного позиционирования

### 4. MessageQueue

**Файл:** `MessageQueue.java`
**Ответственность:** Управление очередью сообщений

- Хранит сообщения, ожидающие отображения
- Контролирует минимальный интервал между спавном сообщений

### 5. MessageLifecycleManager

**Файл:** `MessageLifecycleManager.java`
**Ответственность:** Управление жизненным циклом сообщений

- Обновляет состояние всех активных сообщений
- Управляет заморозкой сообщений при взгляде игрока
- Удаляет старые сообщения с учетом замороженного времени

### 6. MessageRenderer

**Файл:** `MessageRenderer.java`
**Ответственность:** Отрисовка сообщений в мире

- Рендерит текст и фоновую панель
- Использует 9-slice технику для панели
- Применяет анимации падения и исчезновения

### 7. MessageSpawner

**Файл:** `MessageSpawner.java`
**Ответственность:** Координация системы сообщений

- Создает и управляет всеми компонентами
- Обрабатывает новые сообщения из очереди
- Координирует жизненный цикл сообщений

### 8. MessageSystemFactory

**Файл:** `MessageSystemFactory.java`
**Ответственность:** Фабрика для создания системы сообщений

- Создает и настраивает все компоненты системы
- Обеспечивает единую точку входа для создания системы

## Преимущества новой архитектуры

1. **Разделение ответственности:** Каждый компонент отвечает за свою область
2. **Тестируемость:** Компоненты можно тестировать независимо
3. **Расширяемость:** Легко добавлять новые функции
4. **Читаемость:** Код стал более понятным и структурированным
5. **Переиспользование:** Компоненты можно использовать в других частях мода

## Использование

```java
// Создание системы через фабрику
MessageSpawner messageSpawner = MessageSystemFactory.createMessageSystem();

// Добавление сообщения
messageSpawner.setCurrentMessage("Привет, мир!");

// Остановка системы
messageSpawner.setCurrentMessage("");
```

## Конфигурация

Все настройки находятся в `ModConfig.java`:

- `MESSAGE_LIFETIME_TICKS` - время жизни сообщения
- `MESSAGE_FALL_TICKS` - время плавного исчезновения
- `ENABLE_FREEZING_ON_VIEW` - включение заморозки при взгляде
- `MAX_FREEZE_DISTANCE` - максимальное расстояние для заморозки

## Изменения в логике заморозки (v2.0)

**Старая логика (неправильная):**

- Проверяла угол между направлением взгляда и вектором к центру сообщения
- Проблемы: большие сообщения исчезали при взгляде на них, если угол к центру был больше заданного

**Новая логика (правильная):**

- Проверяет пересечение луча взгляда с плоскостью сообщения
- Учитывает размеры текстуры сообщения
- Работает корректно для сообщений любого размера
- Убрана настройка угла обзора (больше не нужна)
